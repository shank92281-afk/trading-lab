services:
  nginx:
    image: nginx:stable
    container_name: trading-lab-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gw-1
      - api-gw-2
    networks:
      - labnet

  # ------------------------
  # API GATEWAY (2 replicas)
  # ------------------------
  api-gw-1:
    build:
      context: ./services/api-gateway
    container_name: api-gw-1
    environment:
      - ORDER_URL=http://nginx/order
      - JWT_SECRET=MY_SUPER_SECRET
    expose:
      - "8000"
    networks:
      - labnet

  api-gw-2:
    build:
      context: ./services/api-gateway
    container_name: api-gw-2
    environment:
      - ORDER_URL=http://nginx/order
      - JWT_SECRET=MY_SUPER_SECRET
    expose:
      - "8000"
    networks:
      - labnet

  # ------------------------
  # ORDER SERVICE (2 replicas)
  # ------------------------
  order-svc-1:
    build:
      context: ./services/order-service
    container_name: order-svc-1
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
    expose:
      - "8001"
    networks:
      - labnet
    depends_on:
      - kafka

  order-svc-2:
    build:
      context: ./services/order-service
    container_name: order-svc-2
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
    expose:
      - "8001"
    networks:
      - labnet
    depends_on:
      - kafka

  # ------------------------
  # MATCHING ENGINE
  # ------------------------
  matching-engine:
    build:
      context: ./services/matching-engine
    container_name: matching-engine
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
      - REDIS_HOST=redis
    expose:
      - "8003"
    depends_on:
      - kafka
      - redis
    networks:
      - labnet

  # ------------------------
  # AUTH SERVICE
  # ------------------------
  auth-service:
    build:
      context: ./services/auth-service
    container_name: auth-service
    environment:
      - JWT_SECRET=MY_SUPER_SECRET    # change to a secure secret in prod
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8004:8004"
    depends_on:
      - redis
    networks:
      - labnet

  # ------------------------
  # FRONTEND
  # ------------------------
  frontend:
    build:
      context: ./frontend
    container_name: frontend
    ports:
      - "8080:80"
    depends_on:
      - nginx
    networks:
      - labnet

  # ------------------------
  # KAFKA + ZOOKEEPER
  # ------------------------
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    networks:
      - labnet

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    depends_on:
      - zookeeper
    networks:
      - labnet

  # ------------------------
  # REDIS
  # ------------------------
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - labnet

networks:
  labnet:
    driver: bridge

