events {}

http {

    # -----------------------------
    # Upstream: API Gateway (8000)
    # -----------------------------
    upstream api_gw_up {
        server api-gw-1:8000;
        server api-gw-2:8000;
    }

    # -----------------------------
    # Upstream: Order Service (8001)
    # -----------------------------
    upstream order_svc_up {
        server order-svc-1:8001;
        server order-svc-2:8001;
    }

    # ---------------------------------------
    # Upstream: Matching Engine HTTP (8003)
    # ---------------------------------------
    upstream matching_up {
        server matching-engine:8003;
    }

    server {
        listen 80;

        # -------------------------
        # Global CORS (Safe Setup)
        # -------------------------
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

        # Handle OPTIONS preflight
        if ($request_method = OPTIONS) {
            return 204;
        }

        # -------------------------
        # /place_order → API Gateway
        # -------------------------
        location /place_order {
            proxy_pass http://api_gw_up;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # -------------------------
        # /order → Order Service
        # -------------------------
        location /order {
            proxy_pass http://order_svc_up;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ----------------------------------------------------
        # /trade/<order_id> → Matching Engine
        # Must forward FULL PATH → $request_uri (IMPORTANT)
        # ----------------------------------------------------
        location /trade/ {
            proxy_pass http://matching_up$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # -------------------------
        # Debug: LB whoami checks
        # -------------------------
        location /whoami {
            proxy_pass http://api_gw_up;
        }

        location /order-whoami {
            proxy_pass http://order_svc_up/whoami;
        }
    }
}

